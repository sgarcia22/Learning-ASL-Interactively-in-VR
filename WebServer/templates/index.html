<!DOCTYPE html>
<html>
  <head>
    <title>ASL-VR</title>
    <meta name="description" content="Learning ASL in WebVR with Leap Motion">
    <link id="favicon" rel="icon" href="https://cdn.glitch.com/4a066ef1-9c42-4c50-88b6-f259c389a9d3%2Ficon.svg?v=1572720780009" type="image/x-icon">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="{{url_for('static', filename='style.css')}}">
    <script src="{{url_for('static', filename='leap-0.6.4.min.js')}}" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/109/three.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="{{url_for('static', filename='leap-plugins-0.1.12.min.js')}}" type="text/javascript"></script>
    <script src="{{url_for('static', filename='leap-widgets-0.1.0.min.js')}}" type="text/javascript"></script>
    <script src="{{url_for('static', filename='VRControls.js')}}"></script>
    <script src="{{url_for('static', filename='VREffect.js')}}"></script>
    <style>
        body {
          text-align: center;
          font-weight: bold;
          margin: 0px;
          overflow: auto;
        }
      </style>
  </head>
  <body>
    <div id="output">
    </div>
  </body>
  <script>

    Leap.loop();

    var textFont = null;
    var loader = new THREE.FontLoader();
    loader.load( './static/fonts/helvetiker_regular.json', function(response) {
      textFont = response;
      renderText (chars[currCharIndex]);
    });

    var chars = "abcdefghijklmnopqrstuvwxyz".split('');
    var currCharIndex = 0;
    var count = 0;
    var fps = 60;

    var mesh;
    var textMesh = null;

    var options = {
      enableGestures: true,
      frameEventName: "frame"
    };

    Leap.loop(options, function(frame) { //PC 60 fps, Leap 120 fps

      count += 1;
      if (fps < 60)
        fps -= 1;
      if (fps <= 0) {
        fps = 60;
        renderImage();
        if (textFont != null) renderText (chars[currCharIndex]);
      }
      if(frame.hands.length > 0 && count >= 20 && (fps >= 60))
      {

        var hand = frame.hands[0];
        var bonesDistArr = [];
        hand.fingers.forEach(function(finger) {
          finger.bones.forEach(function (bone) {
            bonesDistArr.push(Math.abs(Leap.vec3.dist(bone.nextJoint, hand.palmPosition)) * 1000);
          });
        });
        $.get("/api/data", {
          data: JSON.stringify({"boneData" : bonesDistArr})
          }, 
          function(err, req, resp){
            var obj = Object.keys(resp.responseJSON);
            if (obj[0] == chars[currCharIndex]) {
              var string = "Predicted: " + obj[0].toString() + " with " + (resp.responseJSON[obj[0]] * 100).toFixed(2).toString() + "% Confidence";
              changeLetter(string);
            }
          });
        count = 0;
      }
    })
      .use('transform', {
        vr: true
      })
      .use('boneHand', {
      targetEl: document.body
      // scene
    });

    function changeLetter (string) {
      camera.remove(mesh);
      currCharIndex++;
      if (textFont != null) renderText (string);
      if (currCharIndex >= chars.length)  
        currCharIndex = 0;
      fps -= 1;
    }
    
    //Render VR
    var boneHand = Leap.loopController.plugins.boneHand;
    var transform = Leap.loopController.plugins.transform;
    var renderer = boneHand.renderer;
    var scene = boneHand.scene;
    var camera = boneHand.camera;
    
    //Splits Screen into two
    var vreffect = new THREE.VREffect(renderer);
    //Moves with VR
    var vrcontrols = new THREE.VRControls(camera);
    //camera's transform will be aplpied to hands and vr transform
    transform.effectiveParent = camera;
    
    boneHand.render = function () {
      vrcontrols.update();
      vreffect.render(scene, camera);
    };

    function renderImage () {
      var img = new Image();
      var height;
      var width;
      img.src = "./static/images/" + chars[currCharIndex] + ".gif";
      img.onload = function(){
        height = img.height;
        width = img.width;
      }
      //Render ASL letter image
      // Create a texture loader so we can load the image file
      var loader = new THREE.TextureLoader();
      var material = new THREE.MeshLambertMaterial({ //Material for images without specular highlights
        map: loader.load('./static/images/' + chars[currCharIndex] + ".gif")
      });
      //create a plane geometry for the image with a width of 10
      // and a height that preserves the image's aspect ratio
      var geometry = new THREE.PlaneGeometry(width, height);
      // combine our image geometry and material into a mesh
      mesh = new THREE.Mesh(geometry, material);
      // set the position of the image mesh in the x,y,z dimensions
      mesh.position.set(-.35, 0, -1.5);
      camera.add(mesh);
    }

    function renderText (inputText) {
      if (textMesh != null) camera.remove(textMesh);
      var textGeometry = new THREE.TextBufferGeometry( inputText , {
        font: textFont,
        size: .15,
        height: 0, // extrusion
        curveSegments: 12,
        bevelThickness: .5,
        bevelSize: .1,
        bevelEnabled: false
      });
      textGeometry.center();
      var material = new THREE.MeshBasicMaterial({ color: 000000 });
      textMesh = new THREE.Mesh( textGeometry, material );
      textMesh.position.set (1.75, 1, -5);
      camera.add( textMesh );
    };
    
    renderImage ();

    // var axisHelper = new THREE.AxisHelper( 0.1 );
    // scene.add( axisHelper );

    // //Button to skip to next letter - https://raw.githubusercontent.com/leapmotion/leapjs-widgets/master/examples/button.html
    // var planeGeo = new THREE.PlaneGeometry(0.1, 0.2);
    // var material = new THREE.MeshPhongMaterial();
    // var buttonMesh = new THREE.Mesh(planeGeo, material);
    // buttonMesh.name = "Skip";
    // var longThrow = -0.1;
    // var squareButton = new PushButton(
    //   new InteractablePlane(buttonMesh, Leap.loopController),
    //   {
    //     locking: false,
    //     longThrow: longThrow
    //   }
    //   ).on('press', function(mesh){
    //     mesh.material.color.setHex(0xccccff);
    //   }).on('release', function(mesh){
    //     mesh.material.color.setHex(0xeeeeee);
    //   });
    // squareButton.plane.hover(
    //   function(mesh){ // over
    //     console.log('hover in');
    //     mesh.material.color.setHex(0xffccff);
    //   },
    //   function(mesh){ // out
    //     console.log('hover out');
    //     mesh.material.color.setHex(0xeeeeee);
    //   }
    // );

  // var base = new THREE.Mesh(new THREE.BoxGeometry(0.1, longThrow, longThrow), new THREE.MeshPhongMaterial({color: 0x222222}));
  // base.position.set(-0.25, .01, -1);
  // base.rotateX(Math.PI * -0.15);
  // base.rotateY(Math.PI * 0.1);
  // buttonMesh.position.set(
  //   -0.25, .01, -longThrow / 2
  // );
  // squareButton.plane.resetPosition(); // resets the original position, etc to the current one
  // base.add(buttonMesh);
  // scene.add(buttonMesh);

  </script>
</html>
